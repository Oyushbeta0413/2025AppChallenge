<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document Analyzer | CTRL + ALT + HEAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <style>
      /* Replace @apply with equivalent Tailwind classes */
      .rec-card {
        background-color: white;
        border: 1px solid #e5e7eb; /* border-gray-200 */
        border-radius: 1rem; /* rounded-2xl */
        padding: 1.25rem; /* p-5 */
        margin-bottom: 1.5rem; /* mb-6 */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06); /* shadow-md */
        transition: all 0.3s; /* transition-all duration-300 */
      }
      .rec-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06); /* hover:shadow-xl */
        transform: scale(1.01); /* hover:scale-[1.01] */
      }

      .rec-title {
        font-size: 1.125rem; /* text-lg */
        font-weight: 700; /* font-bold */
        color: #6b9080; /* text-[#6B9080] */
        margin-bottom: 0.5rem; /* mb-2 */
      }

      .rec-badge {
        font-size: 0.75rem; /* text-xs */
        font-weight: 600; /* font-semibold */
        padding: 0.25rem 0.75rem; /* px-3 py-1 */
        border-radius: 9999px; /* rounded-full */
      }

      .badge-high {
        background-color: #fee2e2; /* bg-red-100 */
        color: #b91c1c; /* text-red-800 */
      }

      .badge-medium {
        background-color: #fef3c7; /* bg-yellow-100 */
        color: #c28f06; /* text-yellow-800 */
      }

      .badge-low {
        background-color: #d1fae5; /* bg-green-100 */
        color: #065f46; /* text-green-800 */
      }

      .rec-content {
        list-style-type: disc; /* list-disc */
        margin-left: 1.25rem; /* ml-5 */
        margin-bottom: 0; /* space-y-2 */
        font-size: 0.875rem; /* text-sm */
        color: #374151; /* text-gray-700 */
      }

      .rec-link {
        color: #6b9080; /* text-[#6B9080] */
        text-decoration: underline; /* underline */
        transition: color 0.2s; /* transition */
      }

      .rec-link:hover {
        color: #4e7267; /* hover:text-[#4E7267] */
      }
    </style>
  </head>
  <body class="bg-[#F7F8F9] font-sans min-h-screen">
    <!-- Navbar -->
    <nav class="bg-white shadow px-6 py-4">
      <div class="container mx-auto flex justify-between items-center">
        <a href="index.html" class="text-2xl font-bold text-[#6B9080]"
          >CTRL + ALT + HEAL</a
        >
        <ul class="flex space-x-6 text-sm font-medium text-gray-700">
          <li><a href="index.html" class="hover:text-[#6B9080]">Home</a></li>
          <li>
            <a href="analyzer.html" class="hover:text-[#6B9080]">Analyzer</a>
          </li>
          <li>
            <a href="profile.html" class="hover:text-[#6B9080]">Profile</a>
          </li>
          <li><a href="login.html" class="hover:text-[#6B9080]">Login</a></li>
          <li>
            <a href="about.html" class="hover:text-[#6B9080]">About Us</a>
          </li>
        </ul>
      </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 mb-16">
      <!-- Upload Section -->
      <div class="bg-white shadow rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold text-[#6B9080] mb-4">
          Upload & Analyze Your Medical PDF or Image
        </h2>
        <input
          type="file"
          id="pdf-upload"
          accept=".pdf, image/*"
          class="w-full mb-4 border border-gray-300 rounded px-3 py-2"
        />
        <button
          id="analyze-btn"
          class="bg-[#6B9080] text-white px-4 py-2 rounded hover:bg-[#5B7A6F] transition-all hover:shadow-lg hover:scale-105 duration-200"
        >
          Analyze with AI
        </button>
        <p id="loading" class="text-gray-600 mt-2">No file uploaded yet.</p>
      </div>

      <!-- Summary Box -->
      <div class="bg-white shadow rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-[#6B9080] mb-3">
          Summarized Text
        </h3>
        <div
          class="whitespace-pre-wrap h-60 overflow-y-auto bg-white text-sm text-gray-800 border border-gray-200 rounded p-4"
        >
          <pre id="summaryBox">...</pre>
        </div>
      </div>

      <!-- AI Recommendations -->
      <div class="bg-white shadow rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-[#6B9080] mb-3">
          AI Recommendations
        </h3>
        <div
          id="recommendations-output"
          class="bg-[#F9FAFB] text-sm text-gray-800 border border-gray-200 rounded p-4 space-y-4"
        >
          Recommendations will appear here.
        </div>
      </div>

      <!-- Chatbot Section -->
      <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-[#6B9080] mb-3">Ask Dr. CTRL</h3>
        <div
          id="chat-output"
          class="space-y-2 h-48 overflow-y-auto border border-gray-200 rounded p-4 bg-[#F9FAFB] text-sm text-gray-800"
        >
          <p>
            <strong>Dr. CTRL:</strong> Hello, I’m Dr. CTRL — your pixel-powered
            digital doctor. Let’s get you healed up, one byte at a time.
          </p>
        </div>
        <div class="flex mt-4 gap-2">
          <input
            type="text"
            id="user-question"
            placeholder="Ask a question about your report"
            class="flex-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-[#6B9080]"
          />
          <button
            id="ask-btn"
            class="bg-[#6B9080] text-white px-4 py-2 rounded hover:bg-[#5B7A6F] transition-all hover:shadow-lg hover:scale-105 duration-200"
          >
            Ask
          </button>
        </div>
      </div>
    </main>

    <script type="module">
      document.addEventListener("DOMContentLoaded", () => {
        const recsOutput = document.getElementById("recommendations-output");
        const loadingEl = document.getElementById("loading");
        const summaryBox = document.getElementById("summaryBox");
        const analyzeBtn = document.getElementById("analyze-btn");
        const chatBox = document.getElementById("chat-output");
        const userQuestionInput = document.getElementById("user-question");
        const askBtn = document.getElementById("ask-btn");

        let extractedText = "";

        analyzeBtn.addEventListener("click", async () => {
          const fileInput = document.getElementById("pdf-upload");
          const file = fileInput.files[0];

          if (!file) {
            loadingEl.textContent = "Please upload a file first.";
            return;
          }

          loadingEl.textContent = "Processing with AI...";
          summaryBox.textContent = "...";
          recsOutput.innerHTML = "";

          try {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("model", "bert");

            const response = await fetch(
              "http://127.0.0.1:5501/analyzer.html",
              {
                method: "POST",
                body: formData,
              }
            );

            if (!response.ok)
              throw new Error(`Backend error: ${response.status}`);

            const realData = await response.json();
            extractedText = realData.ocr_text || "";
            summaryBox.textContent = extractedText;
            renderRecommendations(realData.resolutions);
            loadingEl.textContent = "Analysis complete!";
          } catch (error) {
            console.error(error);
            loadingEl.textContent = "Error: " + error.message;
          }
        });

        function renderRecommendations(resolutions) {
          if (!resolutions || resolutions.length === 0) {
            recsOutput.textContent = "No recommendations found.";
            return;
          }

          recsOutput.innerHTML = "";

          resolutions.forEach((rec) => {
            const severity = rec.severity.toLowerCase();
            let badgeClass = "rec-badge";

            if (severity.includes("high")) badgeClass += " badge-high";
            else if (severity.includes("medium")) badgeClass += " badge-medium";
            else if (severity.includes("low")) badgeClass += " badge-low";

            const card = document.createElement("div");
            card.className = "rec-card";
            card.innerHTML = `
              <div class="flex justify-between items-center mb-3">
                <h4 class="rec-title">${rec.findings}</h4>
                <span class="${badgeClass}">${rec.severity}</span>
              </div>
              <ul class="rec-content">
                <li><strong>Recommendations:</strong> ${rec.recommendations.join(
                  ", "
                )}</li>
                <li><strong>Treatment:</strong> ${
                  rec.treatment_suggestions
                }</li>
                <li><strong>Home Care:</strong> ${rec.home_care_guidance.join(
                  ", "
                )}</li>
                <li><a href="${
                  rec.info_link
                }" target="_blank" class="rec-link">Learn more</a></li>
              </ul>
            `;
            recsOutput.appendChild(card);
          });
        }

        askBtn.addEventListener("click", async () => {
          const question = userQuestionInput.value.trim();

          if (!question || !extractedText) {
            alert("Please upload and analyze a report first!");
            return;
          }

          chatBox.innerHTML += `<p><strong>You:</strong> ${question}</p>`;
          chatBox.scrollTop = chatBox.scrollHeight;

          const answerer = await pipeline(
            "question-answering",
            "Xenova/distilbert-base-uncased-distilled-squad"
          );
          const output = await answerer(question, extractedText);

          chatBox.innerHTML += `<p><strong>Chatbot:</strong> ${output.answer}</p>`;
          userQuestionInput.value = "";
          chatBox.scrollTop = chatBox.scrollHeight;
        });
      });
    </script>
  </body>
</html>
